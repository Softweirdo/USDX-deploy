const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/signing-BjwC1d-q.js","assets/allowance-D02z0OhG.js","assets/index-FZjAev1K.js","assets/index-CHIcPt2L.css","assets/concat-hex-DxRNkFjZ.js","assets/TypedData-BKSvvHeZ.js","assets/Address-BVqhsuI7.js","assets/send-eip712-transaction-BIperi8F.js","assets/eth_sendRawTransaction-DPdnXbFR.js"])))=>i.map(i=>d[i]);
import{ak as vt,aj as Ot,al as xt,a7 as R,aC as Pt,b5 as x,b6 as k,ay as st,aa as N,aD as b,b7 as Lt,ae as rt,b8 as j,aU as Tt,b9 as Dt,ba as it,ax as P,bb as ot,bc as Ut,bd as Et,be as Ct,ab as It,a0 as I,$ as Q}from"./index-FZjAev1K.js";import{y as ct,z as St,a as U,A as Ft,C as X,D as dt,k as z,E as ut,F as _t,I as tt,G as Nt,H as pt,J as lt,e as mt,K as Vt,P as $t,L as V,v as Bt,M as Mt,g as E,l as W,d as C,N as T,O as L,Q as q,R as $,S as Ht,f as Rt,T as kt,x as jt,h as zt,j as Wt,p as qt}from"./allowance-D02z0OhG.js";import{populateEip712Transaction as Kt,signEip712Transaction as Zt}from"./send-eip712-transaction-BIperi8F.js";class Yt extends vt{constructor(n){super(`Filter type "${n}" is not supported.`,{name:"FilterTypeNotSupportedError"})}}const _=ct;function Jt(t){const{abi:n,args:e=[],name:i}=t,o=Ot(i,{strict:!1}),s=n.filter(a=>o?a.type==="function"?St(a)===i:a.type==="event"?_(a)===i:!1:"name"in a&&a.name===i);if(s.length===0)return;if(s.length===1)return s[0];let r;for(const a of s){if(!("inputs"in a))continue;if(!e||e.length===0){if(!a.inputs||a.inputs.length===0)return a;continue}if(!a.inputs||a.inputs.length===0||a.inputs.length!==e.length)continue;if(e.every((d,p)=>{const y="inputs"in a&&a.inputs[p];return y?B(d,y):!1})){if(r&&"inputs"in r&&r.inputs){const d=yt(a.inputs,r.inputs,e);if(d)throw new Ft({abiItem:a,type:d[0]},{abiItem:r,type:d[1]})}r=a}}return r||s[0]}function B(t,n){const e=typeof t,i=n.type;switch(i){case"address":return U(t,{strict:!1});case"bool":return e==="boolean";case"function":return e==="string";case"string":return e==="string";default:return i==="tuple"&&"components"in n?Object.values(n.components).every((o,s)=>B(Object.values(t)[s],o)):/^u?int(8|16|24|32|40|48|56|64|72|80|88|96|104|112|120|128|136|144|152|160|168|176|184|192|200|208|216|224|232|240|248|256)?$/.test(i)?e==="number"||e==="bigint":/^bytes([1-9]|1[0-9]|2[0-9]|3[0-2])?$/.test(i)?e==="string"||t instanceof Uint8Array:/[a-z]+[1-9]{0,3}(\[[0-9]{0,}\])+$/.test(i)?Array.isArray(t)&&t.every(o=>B(o,{...n,type:i.replace(/(\[[0-9]{0,}\])$/,"")})):!1}}function yt(t,n,e){for(const i in t){const o=t[i],s=n[i];if(o.type==="tuple"&&s.type==="tuple"&&"components"in o&&"components"in s)return yt(o.components,s.components,e[i]);const r=[o.type,s.type];if(r.includes("address")&&r.includes("bytes20")?!0:r.includes("address")&&r.includes("string")?U(e[i],{strict:!1}):r.includes("address")&&r.includes("bytes")?U(e[i],{strict:!1}):!1)return r}}const et="/docs/contract/encodeEventTopics";function Qt(t){var c;const{abi:n,eventName:e,args:i}=t;let o=n[0];if(e){const d=Jt({abi:n,name:e});if(!d)throw new X(e,{docsPath:et});o=d}if(o.type!=="event")throw new X(void 0,{docsPath:et});const s=dt(o),r=_(s);let a=[];if(i&&"inputs"in o){const d=(c=o.inputs)==null?void 0:c.filter(y=>"indexed"in y&&y.indexed),p=Array.isArray(i)?i:Object.values(i).length>0?(d==null?void 0:d.map(y=>i[y.name]))??[]:[];p.length>0&&(a=(d==null?void 0:d.map((y,u)=>Array.isArray(p[u])?p[u].map((G,A)=>nt({param:y,value:p[u][A]})):p[u]?nt({param:y,value:p[u]}):null))??[])}return[r,...a]}function nt({param:t,value:n}){if(t.type==="string"||t.type==="bytes")return z(ut(n));if(t.type==="tuple"||t.type.match(/^(.*)\[(\d+)?\]$/))throw new Yt(t.type);return _t([t],[n])}function Xt(t,n){if(!U(t,{strict:!1}))throw new tt({address:t});if(!U(n,{strict:!1}))throw new tt({address:n});return t.toLowerCase()===n.toLowerCase()}const at="/docs/contract/decodeEventLog";function te(t){const{abi:n,data:e,strict:i,topics:o}=t,s=i??!0,[r,...a]=o;if(!r)throw new Nt({docsPath:at});const c=n.length===1?n[0]:n.find(m=>m.type==="event"&&r===_(dt(m)));if(!(c&&"name"in c)||c.type!=="event")throw new pt(r,{docsPath:at});const{name:d,inputs:p}=c,y=p==null?void 0:p.some(m=>!("name"in m&&m.name));let u=y?[]:{};const G=p.filter(m=>"indexed"in m&&m.indexed);for(let m=0;m<G.length;m++){const g=G[m],h=a[m];if(!h)throw new lt({abiItem:c,param:g});u[y?m:g.name||m]=ee({param:g,value:h})}const A=p.filter(m=>!("indexed"in m&&m.indexed));if(A.length>0){if(e&&e!=="0x")try{const m=mt(A,e);if(m)if(y)u=[...u,...m];else for(let g=0;g<A.length;g++)u[A[g].name]=m[g]}catch(m){if(s)throw m instanceof Vt||m instanceof $t?new V({abiItem:c,data:e,params:A,size:xt(e)}):m}else if(s)throw new V({abiItem:c,data:"0x",params:A,size:0})}return{eventName:d,args:Object.values(u).length>0?u:void 0}}function ee({param:t,value:n}){return t.type==="string"||t.type==="bytes"||t.type==="tuple"||t.type.match(/^(.*)\[(\d+)?\]$/)?n:mt([t],n)[0]}function ne(t){const{abi:n,args:e,logs:i,strict:o=!0}=t,s=(()=>{if(t.eventName)return Array.isArray(t.eventName)?t.eventName:[t.eventName]})();return i.map(r=>{var a;try{const c=n.find(p=>p.type==="event"&&r.topics[0]===_(p));if(!c)return null;const d=te({...r,abi:[c],strict:o});return s&&!s.includes(d.eventName)||!ae({args:d.args,inputs:c.inputs,matchArgs:e})?null:{...d,...r}}catch(c){let d,p;if(c instanceof pt)return null;if(c instanceof V||c instanceof lt){if(o)return null;d=c.abiItem.name,p=(a=c.abiItem.inputs)==null?void 0:a.some(y=>!("name"in y&&y.name))}return{...r,args:p?[]:{},eventName:d}}}).filter(Boolean)}function ae(t){const{args:n,inputs:e,matchArgs:i}=t;if(!i)return!0;if(!n)return!1;function o(s,r,a){try{return s.type==="address"?Xt(r,a):s.type==="string"||s.type==="bytes"?z(ut(r))===a:r===a}catch{return!1}}return Array.isArray(n)&&Array.isArray(i)?i.every((s,r)=>{if(s==null)return!0;const a=e[r];return a?(Array.isArray(s)?s:[s]).some(d=>o(a,d,n[r])):!1}):typeof n=="object"&&!Array.isArray(n)&&typeof i=="object"&&!Array.isArray(i)?Object.entries(i).every(([s,r])=>{if(r==null)return!0;const a=e.find(d=>d.name===s);return a?(Array.isArray(r)?r:[r]).some(d=>o(a,d,n[s])):!1}):!1}const se=2n**96n-1n;function re(t){const{logs:n,events:e,strict:i}=t;return ne({logs:n,abi:e.map(o=>o.abiEvent),strict:i})}function ie(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="event")}function ft(t){const{signature:n}=t;let e;return ie(n)?e=n:e=Bt(n),{abiEvent:e,hash:ct(e),topics:Qt({abi:[e],args:t.filters})}}function oe(t={}){return ft({signature:"event UserOperationRevertReason(bytes32 indexed userOpHash, address indexed sender, uint256 nonce, bytes revertReason)",filters:t})}function ce(t={}){return ft({signature:"event PostOpRevertReason(bytes32 indexed userOpHash, address indexed sender, uint256 nonce, bytes revertReason)",filters:t})}function de(t){const{receipt:n}=t,e={...n,transactionHash:n.transactionHash,blockNumber:n.blockNumber?BigInt(n.blockNumber):null,contractAddress:n.contractAddress?n.contractAddress:null,cumulativeGasUsed:n.cumulativeGasUsed?BigInt(n.cumulativeGasUsed):null,effectiveGasPrice:n.effectiveGasPrice?BigInt(n.effectiveGasPrice):null,gasUsed:n.gasUsed?BigInt(n.gasUsed):null,logs:n.logs,to:n.to?n.to:null,transactionIndex:n.transactionIndex,status:n.status,type:n.type};return n.blobGasPrice&&(e.blobGasPrice=BigInt(n.blobGasPrice)),n.blobGasUsed&&(e.blobGasUsed=BigInt(n.blobGasUsed)),{...t,receipt:e,userOpHash:t.userOpHash,actualGasCost:BigInt(t.actualGasCost),actualGasUsed:BigInt(t.actualGasUsed),nonce:BigInt(t.nonce)}}const ue=()=>{const t=BigInt(Math.floor(Math.random()*4294967296)),n=BigInt(Math.floor(Math.random()*4294967296)),e=BigInt(Math.floor(Math.random()*4294967296)),i=BigInt(Math.floor(Math.random()*4294967296)),o=BigInt(Math.floor(Math.random()*4294967296)),s=BigInt(Math.floor(Math.random()*4294967296));return t<<BigInt(160)|n<<BigInt(128)|e<<BigInt(96)|i<<BigInt(64)|o<<BigInt(32)|s};function K(t){return Object.fromEntries(Object.entries(t).map(([n,e])=>[n,e==null||R(e)?e:Pt(e)]))}async function pe(t){return D({...t,operation:"eth_sendUserOperation",params:[K(t.userOp),t.options.entrypointAddress??x]})}async function S(t,n){const e=await D({...t,operation:"eth_estimateUserOperationGas",params:[K(t.userOp),t.options.entrypointAddress??x,n??{}]});return{preVerificationGas:b(e.preVerificationGas),verificationGas:e.verificationGas!==void 0?b(e.verificationGas):void 0,verificationGasLimit:b(e.verificationGasLimit),callGasLimit:b(e.callGasLimit)+Lt,paymasterVerificationGasLimit:e.paymasterVerificationGasLimit!==void 0?b(e.paymasterVerificationGasLimit):void 0,paymasterPostOpGasLimit:e.paymasterPostOpGasLimit!==void 0?b(e.paymasterPostOpGasLimit):void 0}}async function le(t){const n=await D({...t,operation:"thirdweb_getUserOperationGasPrice",params:[]});return{maxPriorityFeePerGas:b(n.maxPriorityFeePerGas),maxFeePerGas:b(n.maxFeePerGas)}}async function me(t){var e,i;const n=await ye(t);if(n){if(n.success===!1){const s=(i=(e=re({events:[oe(),ce()],logs:n.logs})[0])==null?void 0:e.args)==null?void 0:i.revertReason;if(!s)throw new Error(`UserOp failed at txHash: ${n.receipt.transactionHash}`);const r=Mt({data:s});throw new Error(`UserOp failed with reason: '${r.args.join(",")}' at txHash: ${n.receipt.transactionHash}`)}return n.receipt}}async function ye(t){const n=await D({options:t,operation:"eth_getUserOperationReceipt",params:[t.userOpHash]});if(n)return de(n)}async function fe(t){const n=await D({options:t.options,operation:"zk_paymasterData",params:[t.transaction]});return{paymaster:n.paymaster,paymasterInput:n.paymasterInput}}async function he(t){return{transactionHash:(await D({options:t.options,operation:"zk_broadcastTransaction",params:[{...t.transaction,signedTransaction:t.signedTransaction}]})).transactionHash}}async function D(t){const{options:n,operation:e,params:i}=t,o=n.bundlerUrl??k(n.chain),r=await st(n.client)(o,{method:"POST",headers:{"Content-Type":"application/json"},body:N({jsonrpc:"2.0",id:1,method:e,params:i})}),a=await r.json();if(!r.ok||a.error){let c=a.error||r.statusText;typeof c=="object"&&(c=N(c));const d=a.code||"UNKNOWN";throw new Error(`${e} error: ${c}
Status: ${r.status}
Code: ${d}`)}return a.result}async function Ae(t){const{factoryContract:n,predictAddressOverride:e,adminAddress:i,accountSalt:o,accountAddress:s}=t;if(e)return e(n,i);if(s)return s;if(!i)throw new Error("Account address is required to predict the smart wallet address.");const r=o&&R(o)?o:rt(o??"");return E({contract:n,method:"function getAddress(address, bytes) returns (address)",params:[i,r]})}function ht(t){const{adminAddress:n,factoryContract:e,createAccountOverride:i,accountSalt:o}=t;if(i)return i(e,n);const s=o&&R(o)?o:rt(o??"");return W({contract:e,method:"function createAccount(address, bytes) returns (address)",params:[n,s]})}function At(t){const{accountContract:n,transaction:e,executeOverride:i}=t;return i?i(n,e):W({contract:n,method:"function execute(address, uint256, bytes)",params:[e.to||"",e.value||0n,e.data||"0x"],gas:e.gas?e.gas+21000n:void 0})}function ge(t){const{accountContract:n,transactions:e,executeBatchOverride:i}=t;return i?i(n,e):W({contract:n,method:"function executeBatch(address[], uint256[], bytes[])",params:[e.map(o=>o.to||""),e.map(o=>o.value||0n),e.map(o=>o.data||"0x")]})}const Ge="0x35567e1a",we=[{type:"address",name:"sender"},{type:"uint192",name:"key"}],be=[{type:"uint256",name:"nonce"}];async function ve(t){return E({contract:t.contract,method:[Ge,we,be],params:[t.sender,t.key]})}const Oe="0xa6193531",xe=[{type:"tuple",name:"userOp",components:[{type:"address",name:"sender"},{type:"uint256",name:"nonce"},{type:"bytes",name:"initCode"},{type:"bytes",name:"callData"},{type:"uint256",name:"callGasLimit"},{type:"uint256",name:"verificationGasLimit"},{type:"uint256",name:"preVerificationGas"},{type:"uint256",name:"maxFeePerGas"},{type:"uint256",name:"maxPriorityFeePerGas"},{type:"bytes",name:"paymasterAndData"},{type:"bytes",name:"signature"}]}],Pe=[{type:"bytes32"}];async function Le(t){return E({contract:t.contract,method:[Oe,xe,Pe],params:[t.userOp]})}const Te="0x22cdde4c",De=[{type:"tuple",name:"userOp",components:[{type:"address",name:"sender"},{type:"uint256",name:"nonce"},{type:"bytes",name:"initCode"},{type:"bytes",name:"callData"},{type:"bytes32",name:"accountGasLimits"},{type:"uint256",name:"preVerificationGas"},{type:"bytes32",name:"gasFees"},{type:"bytes",name:"paymasterAndData"},{type:"bytes",name:"signature"}]}],Ue=[{type:"bytes32"}];async function Ee(t){return E({contract:t.contract,method:[Te,De,Ue],params:[t.userOp]})}function Ce(t){return t.factory?C([t.factory,t.factoryData||"0x"]):"0x"}function Ie(t){return C([T(L(t.verificationGasLimit),{size:16}),T(L(t.callGasLimit),{size:16})])}function Se(t){return C([T(L(t.maxPriorityFeePerGas),{size:16}),T(L(t.maxFeePerGas),{size:16})])}function Fe(t){return t.paymaster?C([t.paymaster,T(L(t.paymasterVerificationGasLimit||BigInt(0)),{size:16}),T(L(t.paymasterPostOpGasLimit||BigInt(0)),{size:16}),t.paymasterData||"0x"]):"0x"}const _e=t=>({sender:t.sender,nonce:t.nonce,initCode:Ce(t),callData:t.callData,accountGasLimits:Ie(t),preVerificationGas:t.preVerificationGas,gasFees:Se(t),paymasterAndData:Fe(t),signature:t.signature});async function F(t){var A;const{userOp:n,paymasterOverride:e,client:i,chain:o,entrypointAddress:s}=t;if(e)return e(n);const r={"Content-Type":"application/json"},a=s??x,c=k(o),d={jsonrpc:"2.0",id:1,method:"pm_sponsorUserOperation",params:[K(n),a]},y=await st(i)(c,{method:"POST",headers:r,body:N(d)}),u=await y.json();if(!y.ok){const m=u.error||y.statusText,g=u.code||"UNKNOWN";throw new Error(`Paymaster error: ${m}
Status: ${y.status}
Code: ${g}`)}if(u.result)return typeof u.result=="string"?{paymasterAndData:u.result}:(u.result.policyId&&u.result.reason&&console.warn(`Paymaster policy rejected this transaction with reason: ${u.result.reason} (policyId: ${u.result.policyId})`),{paymasterAndData:u.result.paymasterAndData,verificationGasLimit:u.result.verificationGasLimit?b(u.result.verificationGasLimit):void 0,preVerificationGas:u.result.preVerificationGas?b(u.result.preVerificationGas):void 0,callGasLimit:u.result.callGasLimit?b(u.result.callGasLimit):void 0,paymaster:u.result.paymaster,paymasterData:u.result.paymasterData,paymasterVerificationGasLimit:u.result.paymasterVerificationGasLimit?b(u.result.paymasterVerificationGasLimit):void 0,paymasterPostOpGasLimit:u.result.paymasterPostOpGasLimit?b(u.result.paymasterPostOpGasLimit):void 0});const G=((A=u.error)==null?void 0:A.message)||u.error||y.statusText||"unknown error";throw new Error(`Paymaster error from ${c}: ${G}`)}const Z=new Set,Y=t=>`${t.chain.id}:${t.address}`,gt=t=>{Z.add(Y(t))},Gt=t=>{Z.delete(Y(t))},J=t=>Z.has(Y(t));async function Ne(t){const n=t.timeoutMs||12e4,e=t.intervalMs||1e3,i=Date.now()+n;for(;Date.now()<i;){const o=await me(t);if(o)return o;await new Promise(s=>setTimeout(s,e))}throw new Error(`Timeout waiting for userOp to be mined on chain ${t.chain.id} with UserOp hash: ${t.userOpHash}`)}async function Ve(t){var f;const{transaction:n,accountContract:e,factoryContract:i,adminAddress:o,overrides:s,sponsorGas:r,waitForDeployment:a=!0}=t,c=n.chain,d=n.client,p={client:d,chain:c,bundlerUrl:s==null?void 0:s.bundlerUrl,entrypointAddress:s==null?void 0:s.entrypointAddress},y=j(((f=t.overrides)==null?void 0:f.entrypointAddress)||x),[u,G,A,m,g]=await Promise.all([Tt(e),q(n),$(n.gas),$e({executeTx:n,bundlerOptions:p,chain:c,client:d}),ke({accountContract:e,chain:c,client:d,entrypointAddress:s==null?void 0:s.entrypointAddress,getNonceOverride:s==null?void 0:s.getAccountNonce})]),{maxFeePerGas:h,maxPriorityFeePerGas:l}=m;return y==="v0.7"?Be({bundlerOptions:p,factoryContract:i,accountContract:e,adminAddress:o,sponsorGas:r,overrides:s,isDeployed:u,nonce:g,callData:G,callGasLimit:A,maxFeePerGas:h,maxPriorityFeePerGas:l,waitForDeployment:a}):Me({bundlerOptions:p,factoryContract:i,accountContract:e,adminAddress:o,sponsorGas:r,overrides:s,isDeployed:u,nonce:g,callData:G,callGasLimit:A,maxFeePerGas:h,maxPriorityFeePerGas:l,waitForDeployment:a})}async function $e(t){const{executeTx:n,bundlerOptions:e,chain:i,client:o}=t;let{maxFeePerGas:s,maxPriorityFeePerGas:r}=n;const a=(e==null?void 0:e.bundlerUrl)??k(i);if(Dt(a)){const c=await le({options:e});s=c.maxFeePerGas,r=c.maxPriorityFeePerGas}else{const[c,d]=await Promise.all([$(s),$(r)]);if(c&&d)s=c,r=d;else{const p=await Ht(o,i);r=d??p.maxPriorityFeePerGas??0n,s=c??p.maxFeePerGas??0n}}return{maxFeePerGas:s,maxPriorityFeePerGas:r}}async function Be(t){const{bundlerOptions:n,isDeployed:e,factoryContract:i,accountContract:o,adminAddress:s,sponsorGas:r,overrides:a,nonce:c,callData:d,callGasLimit:p,maxFeePerGas:y,maxPriorityFeePerGas:u,waitForDeployment:G}=t,{chain:A,client:m}=n;let g,h;e||J(o)?(h="0x",G&&await wt(o)):(g=i.address,h=await q(ht({factoryContract:i,adminAddress:s,accountSalt:a==null?void 0:a.accountSalt,createAccountOverride:a==null?void 0:a.createAccount})),gt(o));const l={sender:o.address,nonce:c,callData:d,maxFeePerGas:y,maxPriorityFeePerGas:u,callGasLimit:p??0n,verificationGasLimit:0n,preVerificationGas:0n,factory:g,factoryData:h,paymaster:void 0,paymasterData:"0x",paymasterVerificationGasLimit:0n,paymasterPostOpGasLimit:0n,signature:it};if(r){const f=await F({userOp:l,chain:A,client:m,entrypointAddress:a==null?void 0:a.entrypointAddress,paymasterOverride:a==null?void 0:a.paymaster});if(f.paymaster&&f.paymasterData&&(l.paymaster=f.paymaster,l.paymasterData=f.paymasterData),f.callGasLimit&&f.verificationGasLimit&&f.preVerificationGas&&f.paymasterPostOpGasLimit&&f.paymasterVerificationGasLimit)l.callGasLimit=f.callGasLimit,l.verificationGasLimit=f.verificationGasLimit,l.preVerificationGas=f.preVerificationGas,l.paymasterPostOpGasLimit=f.paymasterPostOpGasLimit,l.paymasterVerificationGasLimit=f.paymasterVerificationGasLimit;else{const w=a!=null&&a.tokenPaymaster?{[a.tokenPaymaster.tokenAddress]:{stateDiff:{[z(Rt([{type:"address"},{type:"uint256"}],[o.address,a.tokenPaymaster.balanceStorageSlot]))]:L(kt,{size:32})}}}:void 0,v=await S({userOp:l,options:n},w);l.callGasLimit=v.callGasLimit,l.verificationGasLimit=v.verificationGasLimit,l.preVerificationGas=v.preVerificationGas,l.paymasterPostOpGasLimit=a!=null&&a.tokenPaymaster?500000n:v.paymasterPostOpGasLimit||0n,l.paymasterVerificationGasLimit=v.paymasterVerificationGasLimit||0n;const O=await F({userOp:l,chain:A,client:m,entrypointAddress:a==null?void 0:a.entrypointAddress,paymasterOverride:a==null?void 0:a.paymaster});O.paymaster&&O.paymasterData&&(l.paymaster=O.paymaster,l.paymasterData=O.paymasterData)}}else{const f=await S({userOp:l,options:n});l.callGasLimit=f.callGasLimit,l.verificationGasLimit=f.verificationGasLimit,l.preVerificationGas=f.preVerificationGas,l.paymasterPostOpGasLimit=f.paymasterPostOpGasLimit||0n,l.paymasterVerificationGasLimit=f.paymasterVerificationGasLimit||0n}return{...l,signature:"0x"}}async function Me(t){const{bundlerOptions:n,isDeployed:e,factoryContract:i,accountContract:o,adminAddress:s,sponsorGas:r,overrides:a,nonce:c,callData:d,callGasLimit:p,maxFeePerGas:y,maxPriorityFeePerGas:u,waitForDeployment:G}=t,{chain:A,client:m}=n;let g;e||J(o)?(g="0x",G&&await wt(o)):(g=await Re({factoryContract:i,adminAddress:s,accountSalt:a==null?void 0:a.accountSalt,createAccountOverride:a==null?void 0:a.createAccount}),gt(o));const h={sender:o.address,nonce:c,initCode:g,callData:d,maxFeePerGas:y,maxPriorityFeePerGas:u,callGasLimit:p??0n,verificationGasLimit:0n,preVerificationGas:0n,paymasterAndData:"0x",signature:it};if(r){const l=await F({userOp:h,chain:A,client:m,entrypointAddress:a==null?void 0:a.entrypointAddress,paymasterOverride:a==null?void 0:a.paymaster}),f="paymasterAndData"in l?l.paymasterAndData:"0x";if(f&&f!=="0x"&&(h.paymasterAndData=f),l.callGasLimit&&l.verificationGasLimit&&l.preVerificationGas)h.callGasLimit=l.callGasLimit,h.verificationGasLimit=l.verificationGasLimit,h.preVerificationGas=l.preVerificationGas;else{const w=await S({userOp:h,options:n});if(h.callGasLimit=w.callGasLimit,h.verificationGasLimit=w.verificationGasLimit,h.preVerificationGas=w.preVerificationGas,f&&f!=="0x"){const v=await F({userOp:h,chain:A,client:m,entrypointAddress:a==null?void 0:a.entrypointAddress,paymasterOverride:a==null?void 0:a.paymaster}),O="paymasterAndData"in v?v.paymasterAndData:"0x";O&&O!=="0x"&&(h.paymasterAndData=O)}}}else{const l=await S({userOp:h,options:n});h.callGasLimit=l.callGasLimit,h.verificationGasLimit=l.verificationGasLimit,h.preVerificationGas=l.preVerificationGas}return{...h,signature:"0x"}}async function He(t){const{userOp:n,chain:e,entrypointAddress:i,adminAccount:o}=t,s=j(i||x);let r;if(s==="v0.7"){const a=_e(n);r=await Ee({contract:P({address:i||ot,chain:e,client:t.client}),userOp:a})}else r=await Le({contract:P({address:i||x,chain:e,client:t.client}),userOp:n});if(o.signMessage){const a=await o.signMessage({message:{raw:Ut(r)}});return{...n,signature:a}}throw new Error("signMessage not implemented in signingAccount")}async function Re(t){const{factoryContract:n,adminAddress:e,accountSalt:i,createAccountOverride:o}=t,s=ht({factoryContract:n,adminAddress:e,accountSalt:i,createAccountOverride:o});return C([n.address,await q(s)])}async function ke(t){const{accountContract:n,chain:e,client:i,entrypointAddress:o,getNonceOverride:s}=t;return s?s(n):await ve({contract:P({address:o||x,chain:e,client:i}),key:ue(),sender:n.address})}async function wt(t){const n=Date.now();for(;J(t);){if(Date.now()-n>6e4)throw Gt(t),new Error("Account deployment is taking too long (over 1 minute). Please try again.");await new Promise(e=>setTimeout(e,500))}}const bt=new WeakMap,M=new WeakMap;async function je(t,n){var G,A,m,g,h,l,f;const{personalAccount:e,client:i,chain:o}=t;if(!e)throw new Error("No personal account provided for smart account connection");const s=n,r=o??s.chain;if(s.factoryAddress&&!((G=s.overrides)!=null&&G.entrypointAddress)){const w=await Ze(s.factoryAddress,i,r);w&&(s.overrides={...s.overrides,entrypointAddress:w})}(A=s.overrides)!=null&&A.tokenPaymaster&&!((m=s.overrides)!=null&&m.entrypointAddress)&&(s.overrides={...s.overrides,entrypointAddress:ot});const a=s.factoryAddress??Et((g=s.overrides)==null?void 0:g.entrypointAddress),c="gasless"in s?s.gasless:s.sponsorGas;if(await Ct(r))return[Ke({creationOptions:n,connectionOptions:t,chain:r,sponsorGas:c}),r];const d=P({client:i,address:a,chain:r}),p=await Ae({factoryContract:d,adminAddress:e.address,predictAddressOverride:(h=s.overrides)==null?void 0:h.predictAddress,accountSalt:(l=s.overrides)==null?void 0:l.accountSalt,accountAddress:(f=s.overrides)==null?void 0:f.accountAddress}).then(w=>w).catch(w=>{throw new Error(`Failed to get account address with factory contract ${d.address} on chain ID ${r.id}: ${(w==null?void 0:w.message)||"unknown error"}`,{cause:w})}),y=P({client:i,address:p,chain:r}),u=await We({...s,chain:r,sponsorGas:c,personalAccount:e,accountContract:y,factoryContract:d,client:i});return bt.set(e,u),M.set(u,e),[u,r]}async function ze(t){const n=M.get(t);n&&(bt.delete(n),M.delete(t))}async function We(t){var o,s;const n=(o=t.overrides)==null?void 0:o.tokenPaymaster;if(n&&j(((s=t.overrides)==null?void 0:s.entrypointAddress)||x)!=="v0.7")throw new Error("Token paymaster is only supported for entrypoint version v0.7");let e=t.accountContract;const i={address:It(e.address),async sendTransaction(r){var d,p,y;let a;if(n){await qe({accountContract:e,erc20Paymaster:n,options:t});const u=async()=>({paymaster:n.paymasterAddress,paymasterData:"0x"});a=((d=t.overrides)==null?void 0:d.paymaster)||u}else a=(p=t.overrides)==null?void 0:p.paymaster;r.chainId!==e.chain.id&&(e=P({address:i.address,chain:I(r.chainId),client:t.client}));const c=At({accountContract:e,transaction:r,executeOverride:(y=t.overrides)==null?void 0:y.execute});return H({executeTx:c,options:{...t,chain:I(r.chainId),accountContract:e,overrides:{...t.overrides,paymaster:a}}})},async sendBatchTransaction(r){var c,d;const a=ge({accountContract:e,transactions:r,executeBatchOverride:(c=t.overrides)==null?void 0:c.executeBatch});return H({executeTx:a,options:{...t,chain:I(((d=r[0])==null?void 0:d.chainId)??t.chain.id),accountContract:e}})},async signMessage({message:r}){var c;if((c=t.overrides)!=null&&c.signMessage)return t.overrides.signMessage({adminAccount:t.personalAccount,factoryContract:t.factoryContract,accountContract:e,message:r});const{smartAccountSignMessage:a}=await Q(async()=>{const{smartAccountSignMessage:d}=await import("./signing-BjwC1d-q.js");return{smartAccountSignMessage:d}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));return a({accountContract:e,factoryContract:t.factoryContract,options:t,message:r})},async signTypedData(r){var c;if((c=t.overrides)!=null&&c.signTypedData)return t.overrides.signTypedData({adminAccount:t.personalAccount,factoryContract:t.factoryContract,accountContract:e,typedData:r});const{smartAccountSignTypedData:a}=await Q(async()=>{const{smartAccountSignTypedData:d}=await import("./signing-BjwC1d-q.js");return{smartAccountSignTypedData:d}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));return a({accountContract:e,factoryContract:t.factoryContract,options:t,typedData:r})},async onTransactionRequested(r){var a,c;return(c=(a=t.personalAccount).onTransactionRequested)==null?void 0:c.call(a,r)}};return i}async function qe(t){var p;const{accountContract:n,erc20Paymaster:e,options:i}=t,o=e.tokenAddress,s=P({address:o,chain:n.chain,client:n.client});if(await jt({contract:s,owner:n.address,spender:e.paymasterAddress})>0n)return;const a=zt({contract:s,spender:e.paymasterAddress,amountWei:se-1n}),c=await Wt({transaction:a,from:n.address}),d=At({accountContract:n,transaction:c,executeOverride:(p=i.overrides)==null?void 0:p.execute});await H({executeTx:d,options:{...i,overrides:{...i.overrides,tokenPaymaster:void 0}}})}function Ke(t){const{creationOptions:n,connectionOptions:e,chain:i}=t,o={address:e.personalAccount.address,async sendTransaction(s){var p,y,u,G;const r={data:s.data,to:s.to??void 0,value:s.value??0n,chain:I(s.chainId),client:e.client,eip712:s.eip712};let a=await Kt({account:o,transaction:r});if(t.sponsorGas&&!a.paymaster){const A=await fe({options:{client:e.client,chain:i,bundlerUrl:(p=n.overrides)==null?void 0:p.bundlerUrl,entrypointAddress:(y=n.overrides)==null?void 0:y.entrypointAddress},transaction:a});a={...a,...A}}const c=await Zt({account:o,chainId:i.id,eip712Transaction:a});return{transactionHash:(await he({options:{client:e.client,chain:i,bundlerUrl:(u=n.overrides)==null?void 0:u.bundlerUrl,entrypointAddress:(G=n.overrides)==null?void 0:G.entrypointAddress},transaction:a,signedTransaction:c})).transactionHash,client:e.client,chain:i}},async signMessage({message:s}){return e.personalAccount.signMessage({message:s})},async signTypedData(s){const r=qt(s);return e.personalAccount.signTypedData(r)},async onTransactionRequested(s){var r,a;return(a=(r=e.personalAccount).onTransactionRequested)==null?void 0:a.call(r,s)}};return o}async function H(t){var c,d,p;const{executeTx:n,options:e}=t,i=await Ve({transaction:n,factoryContract:e.factoryContract,accountContract:e.accountContract,adminAddress:e.personalAccount.address,sponsorGas:e.sponsorGas,overrides:e.overrides}),o=await He({client:e.client,chain:e.chain,adminAccount:e.personalAccount,entrypointAddress:(c=e.overrides)==null?void 0:c.entrypointAddress,userOp:i}),s={chain:e.chain,client:e.client,bundlerUrl:(d=e.overrides)==null?void 0:d.bundlerUrl,entrypointAddress:(p=e.overrides)==null?void 0:p.entrypointAddress},r=await pe({options:s,userOp:o}),a=await Ne({...s,userOpHash:r});return Gt(e.accountContract),{client:e.client,chain:e.chain,transactionHash:a.transactionHash}}async function Ze(t,n,e){const i=P({address:t,client:n,chain:e});try{return await E({contract:i,method:"function entrypoint() public view returns (address)"})}catch{return}}const Xe=Object.freeze(Object.defineProperty({__proto__:null,connectSmartAccount:je,disconnectSmartAccount:ze},Symbol.toStringTag,{value:"Module"}));export{Jt as g,Xe as i,ht as p};
