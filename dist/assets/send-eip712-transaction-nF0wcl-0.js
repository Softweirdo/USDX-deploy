import{e as D}from"./eth_sendRawTransaction-DPdnXbFR.js";import{ak as I,aj as z,af as S,aC as d,aE as _,ab as C}from"./index-fsOahuMz.js";import{concatHex as M}from"./concat-hex-DAZrkHn2.js";import{U as v,b as $,V as A,W as k,X as L,Y as T,Z as W,_ as O,$ as V,a0 as p,E as w,O as N,N as R,j as Z,R as b,Q as K}from"./allowance-Dq4y5cN1.js";function Q(e,t="hex"){const n=F(e),a=v(new Uint8Array(n.length));return n.encode(a),t==="hex"?$(a.bytes):a.bytes}function F(e){return Array.isArray(e)?X(e.map(t=>F(t))):Y(e)}function X(e){const t=e.reduce((s,r)=>s+r.length,0),n=G(t);return{length:t<=55?1+t:1+n+t,encode(s){t<=55?s.pushByte(192+t):(s.pushByte(247+n),n===1?s.pushUint8(t):n===2?s.pushUint16(t):n===3?s.pushUint24(t):s.pushUint32(t));for(const{encode:r}of e)r(s)}}}function Y(e){const t=typeof e=="string"?A(e):e,n=G(t.length);return{length:t.length===1&&t[0]<128?1:t.length<=55?1+t.length:1+n+t.length,encode(s){t.length===1&&t[0]<128?s.pushBytes(t):t.length<=55?(s.pushByte(128+t.length),s.pushBytes(t)):(s.pushByte(183+n),n===1?s.pushUint8(t.length):n===2?s.pushUint16(t.length):n===3?s.pushUint24(t.length):s.pushUint32(t.length),s.pushBytes(t))}}}function G(e){if(e<2**8)return 1;if(e<2**16)return 2;if(e<2**24)return 3;if(e<2**32)return 4;throw new I("Length is too large.")}const q=2n**16n-1n;function J(e,t,n,a){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,n,a);const s=BigInt(32),r=BigInt(4294967295),i=Number(n>>s&r),o=Number(n&r),h=a?4:0,f=a?0:4;e.setUint32(t+h,i,a),e.setUint32(t+f,o,a)}const j=(e,t,n)=>e&t^~e&n,tt=(e,t,n)=>e&t^e&n^t&n;class et extends k{constructor(t,n,a,s){super(),this.blockLen=t,this.outputLen=n,this.padOffset=a,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=L(this.buffer)}update(t){T(this);const{view:n,buffer:a,blockLen:s}=this;t=W(t);const r=t.length;for(let i=0;i<r;){const o=Math.min(s-this.pos,r-i);if(o===s){const h=L(t);for(;s<=r-i;i+=s)this.process(h,i);continue}a.set(t.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){T(this),O(t,this),this.finished=!0;const{buffer:n,view:a,blockLen:s,isLE:r}=this;let{pos:i}=this;n[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>s-i&&(this.process(a,0),i=0);for(let c=i;c<s;c++)n[c]=0;J(a,s-8,BigInt(this.length*8),r),this.process(a,0);const o=L(t),h=this.outputLen;if(h%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const f=h/4,u=this.get();if(f>u.length)throw new Error("_sha2: outputLen bigger than state");for(let c=0;c<f;c++)o.setUint32(4*c,u[c],r)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const a=t.slice(0,n);return this.destroy(),a}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:n,buffer:a,length:s,finished:r,destroyed:i,pos:o}=this;return t.length=s,t.pos=o,t.finished=r,t.destroyed=i,s%n&&t.buffer.set(a),t}}const nt=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),y=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),l=new Uint32Array(64);class st extends et{constructor(){super(64,32,8,!1),this.A=y[0]|0,this.B=y[1]|0,this.C=y[2]|0,this.D=y[3]|0,this.E=y[4]|0,this.F=y[5]|0,this.G=y[6]|0,this.H=y[7]|0}get(){const{A:t,B:n,C:a,D:s,E:r,F:i,G:o,H:h}=this;return[t,n,a,s,r,i,o,h]}set(t,n,a,s,r,i,o,h){this.A=t|0,this.B=n|0,this.C=a|0,this.D=s|0,this.E=r|0,this.F=i|0,this.G=o|0,this.H=h|0}process(t,n){for(let c=0;c<16;c++,n+=4)l[c]=t.getUint32(n,!1);for(let c=16;c<64;c++){const x=l[c-15],g=l[c-2],B=p(x,7)^p(x,18)^x>>>3,m=p(g,17)^p(g,19)^g>>>10;l[c]=m+l[c-7]+B+l[c-16]|0}let{A:a,B:s,C:r,D:i,E:o,F:h,G:f,H:u}=this;for(let c=0;c<64;c++){const x=p(o,6)^p(o,11)^p(o,25),g=u+x+j(o,h,f)+nt[c]+l[c]|0,m=(p(a,2)^p(a,13)^p(a,22))+tt(a,s,r)|0;u=f,f=h,h=o,o=i+g|0,i=r,r=s,s=a,a=g+m|0}a=a+this.A|0,s=s+this.B|0,r=r+this.C|0,i=i+this.D|0,o=o+this.E|0,h=h+this.F|0,f=f+this.G|0,u=u+this.H|0,this.set(a,s,r,i,o,h,f,u)}roundClean(){l.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const at=V(()=>new st);function it(e,t){const n=at(z(e,{strict:!1})?w(e):e);return N(n)}function P(e){if(["string","number"].includes(typeof e)&&!Number.isInteger(Number(e)))throw new Error(`Expected value to be an integer to convert to a bigint, got ${e} of type ${typeof e}`);return e instanceof Uint8Array?BigInt(S(e)):BigInt(e)}const E=(e,t)=>typeof e=="bigint"?t(e):Array.isArray(e)?e.map(n=>E(n,t)):e&&typeof e=="object"?Object.fromEntries(Object.entries(e).map(([n,a])=>[n,E(a,t)])):e,U=q*32n;class rt extends I{constructor({givenLength:t,maxBytecodeSize:n}){super(`Bytecode cannot be longer than ${n} bytes. Given length: ${t}`,{name:"BytecodeLengthExceedsMaxSizeError"})}}class ot extends I{constructor({givenLengthInWords:t}){super(`Bytecode length in 32-byte words must be odd. Given length in words: ${t}`,{name:"BytecodeLengthInWordsMustBeOddError"})}}class ct extends I{constructor({givenLength:t}){super(`The bytecode length in bytes must be divisible by 32. Given length: ${t}`,{name:"BytecodeLengthMustBeDivisibleBy32Error"})}}function ht(e){const t=w(e);if(t.length%32!==0)throw new ct({givenLength:t.length});if(t.length>U)throw new rt({givenLength:t.length,maxBytecodeSize:U});const n=it(t),a=w(n),s=t.length/32;if(s%2===0)throw new ot({givenLengthInWords:s});const r=w(s),i=R(r,{size:2}),o=new Uint8Array([1,0]);return a.set(o,0),a.set(i,2),a}const H=50000n,ft=e=>{const t=ut(e);return{domain:{name:"zkSync",version:"2",chainId:e.chainId},types:{Transaction:[{name:"txType",type:"uint256"},{name:"from",type:"uint256"},{name:"to",type:"uint256"},{name:"gasLimit",type:"uint256"},{name:"gasPerPubdataByteLimit",type:"uint256"},{name:"maxFeePerGas",type:"uint256"},{name:"maxPriorityFeePerGas",type:"uint256"},{name:"paymaster",type:"uint256"},{name:"nonce",type:"uint256"},{name:"value",type:"uint256"},{name:"data",type:"bytes"},{name:"factoryDeps",type:"bytes32[]"},{name:"paymasterInput",type:"bytes"}]},primaryType:"Transaction",message:t}};function ut(e){const{gas:t,nonce:n,to:a,from:s,value:r,maxFeePerGas:i,maxPriorityFeePerGas:o,paymaster:h,paymasterInput:f,gasPerPubdata:u,data:c,factoryDeps:x}=e;return{txType:113n,from:BigInt(s),to:a?BigInt(a):0n,gasLimit:t??0n,gasPerPubdataByteLimit:u??H,maxFeePerGas:i??0n,maxPriorityFeePerGas:o??0n,paymaster:h?BigInt(h):0n,nonce:n?BigInt(n):0n,value:r??0n,data:c||"0x0",factoryDeps:(x==null?void 0:x.map(g=>d(ht(g))))??[],paymasterInput:f||"0x"}}async function Pt(e){const{account:t,transaction:n}=e,a=await xt(e),s=await dt({account:t,eip712Transaction:a,chainId:n.chain.id}),r=_(n);return{transactionHash:await D(r,s),chain:n.chain,client:n.client}}async function dt(e){const{account:t,eip712Transaction:n,chainId:a}=e,s=ft(n),r=await t.signTypedData({...s});return gt({...n,chainId:a,customSignature:r})}async function xt(e){const{account:t,transaction:n}=e,{gas:a,maxFeePerGas:s,maxPriorityFeePerGas:r,gasPerPubdata:i}=await pt({transaction:n,from:C(t.address)});return{...await Z({transaction:{...n,gas:a,maxFeePerGas:s,maxPriorityFeePerGas:r},from:t.address}),...n.eip712,gasPerPubdata:i,from:t.address}}function gt(e){const{chainId:t,gas:n,nonce:a,to:s,from:r,value:i,maxFeePerGas:o,maxPriorityFeePerGas:h,customSignature:f,factoryDeps:u,paymaster:c,paymasterInput:x,gasPerPubdata:g,data:B}=e,m=[a?d(a):"0x",h?d(h):"0x",o?d(o):"0x",n?d(n):"0x",s??"0x",i?d(i):"0x",B??"0x0",d(t),d(""),d(""),d(t),r??"0x",g?d(g):d(H),u??[],f??"0x",c&&x?[c,x]:[]];return M(["0x71",Q(m)])}async function pt(e){const{transaction:t,from:n}=e;let[a,s,r,i]=await Promise.all([b(t.gas),b(t.maxFeePerGas),b(t.maxPriorityFeePerGas),b(t.eip712)]),o=i==null?void 0:i.gasPerPubdata;if(a===void 0||s===void 0||r===void 0){const h=_(t),f=await yt({transaction:t,from:n}),u=await h({method:"zks_estimateFee",params:[E(f,d)]});a=P(u.gas_limit)*2n,s=P(u.max_fee_per_gas)*2n,r=P(u.max_priority_fee_per_gas)||1n,o=P(u.gas_per_pubdata_limit)*2n,o<50000n&&(o=50000n)}return{gas:a,maxFeePerGas:s,maxPriorityFeePerGas:r,gasPerPubdata:o}}async function yt(e){var h;const{transaction:t,from:n}=e,[a,s,r,i]=await Promise.all([K(t),b(t.to),b(t.value),b(t.eip712)]),o=i==null?void 0:i.gasPerPubdata;return{from:n,to:s,data:a,value:r,gasPerPubdata:o,eip712Meta:{...i,gasPerPubdata:o||50000n,factoryDeps:(h=i==null?void 0:i.factoryDeps)==null?void 0:h.map(f=>Array.from(A(f)))},type:"0x71"}}export{pt as getZkGasFees,xt as populateEip712Transaction,Pt as sendEip712Transaction,dt as signEip712Transaction};
